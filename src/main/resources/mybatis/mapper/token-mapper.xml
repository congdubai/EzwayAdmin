<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.infoplus.ezway.EzwayAdmin.mapper.TokenMapper">

    <resultMap id="tokenResultMap" type="com.infoplus.ezway.EzwayAdmin.entity.Token">
        <id property="id" column="id"/>
        <result property="accessTaken" column="access_token"/>
        <result property="refreshToken" column="refresh_token"/>
        <result property="tokenType" column="token_type"/>
        <result property="revoked" column="revoked"/>
        <result property="expired" column="expired"/>
        <result property="userId" column="user_id"/>
        <!-- Add other properties as needed -->
    </resultMap>

    <select id="findAllValidTokenByUser" resultMap="tokenResultMap">
        <![CDATA[
        SELECT T.*
        FROM tbl_token T
                 INNER JOIN tbl_user U ON T.user_id = U.id
        WHERE U.id = #{userId}
          AND (T.expired = 0 OR T.revoked = 0)
        ]]>
    </select>

    <select id="findByToken" resultMap="tokenResultMap">
        <![CDATA[
        SELECT *
        FROM tbl_token T
        WHERE T.access_token = #{token}
        ]]>
    </select>

    <update id="revokedToken" parameterType="com.infoplus.ezway.EzwayAdmin.entity.Token">
        UPDATE tbl_token
        SET expired=1,
            revoked=1
        WHERE id = #{id}
    </update>


    <insert id="insertNewToken" parameterType="com.infoplus.ezway.EzwayAdmin.entity.Token">
        INSERT INTO tbl_token(access_token, refresh_token, revoked, expired, user_id)
        VALUES (#{accessTaken}, #{refreshToken}, #{revoked}, #{expired}, #{userId})
    </insert>
</mapper>
